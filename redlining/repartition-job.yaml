apiVersion: batch/v1
kind: Job
metadata:
  name: mappinginequality-repartition
  namespace: biodiversity
spec:
  completions: 1
  parallelism: 1
  template:
    spec:
      affinity:
        nodeAffinity:
          requiredDuringSchedulingIgnoredDuringExecution:
            nodeSelectorTerms:
            - matchExpressions:
              - key: feature.node.kubernetes.io/pci-10de.present
                operator: NotIn
                values:
                - 'true'
      containers:
      - args:
        - "\nset -e\napt-get update\npip install geopandas pyarrow duckdb h3 boto3\n\
          \npython -c '\nimport duckdb\nfrom cng.utils import set_secrets\nimport\
          \ shutil\n\ncon = duckdb.connect()\nset_secrets(con)\ncon.execute(\"SET\
          \ preserve_insertion_order=false\")\ncon.execute(\"SET http_timeout=1200\"\
          )\ncon.execute(\"SET http_retries=30\")\n\nprint(\"Repartitioning by h0...\"\
          )\ncon.execute(\"\"\"\n    COPY (SELECT * FROM read_parquet('s3://public-mappinginequality/chunks/*.parquet'))\n\
          \    TO '/tmp/hex' (FORMAT PARQUET, PARTITION_BY h0)\n\"\"\")\n\ncon.execute(\"\
          \"\"\n    COPY (SELECT * FROM read_parquet('/tmp/hex/**/*.parquet'))\n \
          \   TO 's3://public-mappinginequality/hex/' (FORMAT PARQUET, PARTITION_BY\
          \ h0)\n\"\"\")\n\nshutil.rmtree('/tmp/hex')\nprint('\u2713 Repartitioning\
          \ complete!')\n"
        command:
        - bash
        - -c
        env:
        - name: AWS_ACCESS_KEY_ID
          valueFrom:
            secretKeyRef:
              key: AWS_ACCESS_KEY_ID
              name: aws
        - name: AWS_SECRET_ACCESS_KEY
          valueFrom:
            secretKeyRef:
              key: AWS_SECRET_ACCESS_KEY
              name: aws
        - name: AWS_S3_ENDPOINT
          value: rook-ceph-rgw-nautiluss3.rook
        - name: AWS_PUBLIC_ENDPOINT
          value: s3-west.nrp-nautilus.io
        image: python:3.12-slim
        name: processor
        resources:
          limits:
            cpu: '2'
            memory: 8Gi
          requests:
            cpu: '2'
            memory: 8Gi
      priorityClassName: opportunistic
      restartPolicy: OnFailure
  ttlSecondsAfterFinished: 10800
